<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inject Server - Harley IPTV</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons for copy/clear -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- JSON5 for flexible JSON parsing -->
  <script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js"></script>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="container shadow p-4 rounded mt-5">
    <a href="index2.html" class="back-link mb-3"><i class="bi bi-arrow-left"></i> Back </a>

    <div id="unlockSection" class="unlock-section">
      <div class="mb-1">Password required to inject server:</div>
      <input type="password" id="unlockPwd" class="form-control d-inline-block" placeholder="Type password" autocomplete="off">
      <button class="unlock-btn" id="unlockBtn" type="button">Unlock</button>
      <div id="unlockMsg" class="small text-danger mt-2"></div>
    </div>

    <div id="injectFormSection" class="locked">
      <h3 class="mb-3 text-center">Inject Server to Firestore</h3>
      <form id="serverForm">
        <div class="mb-3">
          <label class="form-label" for="name">Channel Name</label>
          <input type="text" class="form-control" id="name" required placeholder="PBB CE LIVE (TFC)">
        </div>
        <div class="mb-3">
          <label class="form-label" for="drop1">Channel Group/Drop1 <small>(optional, e.g. TFC, CIG, etc.)</small></label>
          <input type="text" class="form-control" id="drop1" placeholder="TFC">
        </div>
        <div class="mb-3">
          <label class="form-label" for="url">Stream URL</label>
          <input type="url" class="form-control" id="url" required placeholder="https://...manifest.mpd">
        </div>
        <div class="mb-3">
          <label class="form-label" for="image">Image URL (optional)</label>
          <input type="url" class="form-control" id="image" placeholder="https://.../logo.png">
          <img id="previewImg" class="preview-img" />
        </div>
        <div class="mb-3 position-relative">
          <label class="form-label" for="key">
            Key(s) <small>(format: <code>keyid:key</code> or multiple lines)</small>
          </label>
          <div class="input-group">
            <textarea class="form-control" id="key" rows="2" placeholder="8438e8495659425585a09749cd6bc39a:9d92b12db092fe6bdf2207ef7a2a9e65"></textarea>
            <button type="button" class="btn btn-outline-secondary btn-icon" data-copy="key" title="Copy"><i class="bi bi-clipboard"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" data-clear="key" title="Clear"><i class="bi bi-x-lg"></i></button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Inject Server</button>
      </form>
      <div class="my-3 text-center">
        <hr>
        <div class="bulk-section">
          <label for="bulkJson" class="form-label">Bulk Inject JSON (<b>paste your JSON object here</b>)</label>
          <div class="input-group">
            <textarea id="bulkJson" class="form-control" placeholder="{...}" rows="5"></textarea>
            <button type="button" class="btn btn-outline-secondary btn-icon" data-copy="bulkJson" title="Copy"><i class="bi bi-clipboard"></i></button>
            <button type="button" class="btn btn-outline-secondary btn-icon" data-clear="bulkJson" title="Clear"><i class="bi bi-x-lg"></i></button>
          </div>
          <label for="uploadJsonInput" class="upload-json-label">
            Upload JSON file (optional): 
            <input type="file" id="uploadJsonInput" accept=".json,application/json">
          </label>
          <button id="bulkInjectBtn" class="btn btn-primary mt-2 w-100">Bulk Inject All</button>
          <div id="bulkProgress" class="mt-2"></div>
        </div>
      </div>
      <div id="resultMsg" class="result-message text-center"></div>
      <!-- ---- NEW: JSON Format Converter Tool ---- -->
      <div class="gen-section">
        <label for="fixJsonIn">Convert any JSON/Array/List to Channel Object Format</label>
        <div class="input-group mb-2">
          <textarea id="fixJsonIn" class="form-control" placeholder="Paste any JSON, array, or list here..." rows="4"></textarea>
          <button type="button" class="btn btn-outline-secondary btn-icon" data-clear="fixJsonIn" title="Clear"><i class="bi bi-x-lg"></i></button>
        </div>
        <button id="fixJsonBtn" class="btn btn-primary w-100 mb-2">Convert & Format</button>
        <label for="fixedJsonOut" class="mb-1">Formatted Object (for bulk inject):</label>
        <div class="input-group">
          <textarea id="fixedJsonOut" readonly></textarea>
          <button type="button" class="btn btn-outline-secondary btn-icon" data-copy="fixedJsonOut" title="Copy"><i class="bi bi-clipboard"></i></button>
          <button type="button" class="btn btn-outline-secondary btn-icon" data-clear="fixedJsonOut" title="Clear"><i class="bi bi-x-lg"></i></button>
        </div>
        <div id="fixJsonMsg" class="small text-danger"></div>
      </div>
      <!-- ---- END NEW TOOL ---- -->
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase Config
const _0x4f0ae1=_0x4e8b;function _0x4e8b(_0x1cf4f1,_0x307dc1){const _0x263406=_0x2634();return _0x4e8b=function(_0x4e8bb7,_0x37b874){_0x4e8bb7=_0x4e8bb7-0xed;let _0x234abe=_0x263406[_0x4e8bb7];if(_0x4e8b['snpiQa']===undefined){var _0x84061c=function(_0x5749f4){const _0x4f1a26='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x6b0777='',_0x3aef1e='';for(let _0xfa46b7=0x0,_0x24f3f3,_0x403078,_0x4bdaf7=0x0;_0x403078=_0x5749f4['charAt'](_0x4bdaf7++);~_0x403078&&(_0x24f3f3=_0xfa46b7%0x4?_0x24f3f3*0x40+_0x403078:_0x403078,_0xfa46b7++%0x4)?_0x6b0777+=String['fromCharCode'](0xff&_0x24f3f3>>(-0x2*_0xfa46b7&0x6)):0x0){_0x403078=_0x4f1a26['indexOf'](_0x403078);}for(let _0x53ecc3=0x0,_0x3a925c=_0x6b0777['length'];_0x53ecc3<_0x3a925c;_0x53ecc3++){_0x3aef1e+='%'+('00'+_0x6b0777['charCodeAt'](_0x53ecc3)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x3aef1e);};const _0x3b1982=function(_0x4c2941,_0x50bb6d){let _0x39fedf=[],_0x5978cd=0x0,_0x1f0cdc,_0x34dded='';_0x4c2941=_0x84061c(_0x4c2941);let _0x164679;for(_0x164679=0x0;_0x164679<0x100;_0x164679++){_0x39fedf[_0x164679]=_0x164679;}for(_0x164679=0x0;_0x164679<0x100;_0x164679++){_0x5978cd=(_0x5978cd+_0x39fedf[_0x164679]+_0x50bb6d['charCodeAt'](_0x164679%_0x50bb6d['length']))%0x100,_0x1f0cdc=_0x39fedf[_0x164679],_0x39fedf[_0x164679]=_0x39fedf[_0x5978cd],_0x39fedf[_0x5978cd]=_0x1f0cdc;}_0x164679=0x0,_0x5978cd=0x0;for(let _0x57f961=0x0;_0x57f961<_0x4c2941['length'];_0x57f961++){_0x164679=(_0x164679+0x1)%0x100,_0x5978cd=(_0x5978cd+_0x39fedf[_0x164679])%0x100,_0x1f0cdc=_0x39fedf[_0x164679],_0x39fedf[_0x164679]=_0x39fedf[_0x5978cd],_0x39fedf[_0x5978cd]=_0x1f0cdc,_0x34dded+=String['fromCharCode'](_0x4c2941['charCodeAt'](_0x57f961)^_0x39fedf[(_0x39fedf[_0x164679]+_0x39fedf[_0x5978cd])%0x100]);}return _0x34dded;};_0x4e8b['BUDxqV']=_0x3b1982,_0x1cf4f1=arguments,_0x4e8b['snpiQa']=!![];}const _0x32ba3d=_0x263406[0x0],_0x32223d=_0x4e8bb7+_0x32ba3d,_0x4fb1e1=_0x1cf4f1[_0x32223d];return!_0x4fb1e1?(_0x4e8b['nGKvju']===undefined&&(_0x4e8b['nGKvju']=!![]),_0x234abe=_0x4e8b['BUDxqV'](_0x234abe,_0x37b874),_0x1cf4f1[_0x32223d]=_0x234abe):_0x234abe=_0x4fb1e1,_0x234abe;},_0x4e8b(_0x1cf4f1,_0x307dc1);}(function(_0x5be3a1,_0x1b5d28){const _0x3fbecd=_0x4e8b,_0x2f276f=_0x5be3a1();while(!![]){try{const _0x5d17f8=parseInt(_0x3fbecd(0xfc,'@USG'))/0x1*(parseInt(_0x3fbecd(0xfd,'gxTS'))/0x2)+parseInt(_0x3fbecd(0x10a,'[@&8'))/0x3*(parseInt(_0x3fbecd(0x101,'N)0&'))/0x4)+parseInt(_0x3fbecd(0xff,'M]Y0'))/0x5*(-parseInt(_0x3fbecd(0xf7,'g1@&'))/0x6)+parseInt(_0x3fbecd(0x102,'9!Da'))/0x7*(parseInt(_0x3fbecd(0xf5,'zNEG'))/0x8)+-parseInt(_0x3fbecd(0x100,'NT2#'))/0x9+-parseInt(_0x3fbecd(0xee,'IOha'))/0xa*(parseInt(_0x3fbecd(0xfb,'[!Su'))/0xb)+-parseInt(_0x3fbecd(0xf1,'a)Uy'))/0xc*(-parseInt(_0x3fbecd(0x107,'2zms'))/0xd);if(_0x5d17f8===_0x1b5d28)break;else _0x2f276f['push'](_0x2f276f['shift']());}catch(_0x474961){_0x2f276f['push'](_0x2f276f['shift']());}}}(_0x2634,0xa0924));function _0x2634(){const _0x3ce87b=['WQhdVd3dPtpcVtBdNLahgvJcKa','uKOoy8o0sxFdS0XBmmk0bW','WOFcKCojoSkMW7tdRCo6WQe4nwOe','W4zznCoWWQqzgSk6cgzeWPO1','WRzlWPRcPWxcUhu','WO3cNZZdHSk0pdHbWQ3dNCkWc3q','WQhdStldOK7dPxddNu4v','cH/dKmkxW6XMwG','W78MWQHrWRTWWO0GddBdKq','CMatxcpcRmo3WRJdJbxdHCkMcuxcNMNcUmo4dSoBWQHXwHrBW5GCWO/dImoOzmkSiCksW5fxhLr8W5a+','W6KQWPBcSSopWOjZWPtdVCoDzb/cKSoLrcxcRCkXWQldSYtcU8o/WRxcVCkyW6uLxmo4W67dRd4','cmkLfmoArmkPWOy','W4VdLWRdTcbyFuDQEGdcGmkuWOtdReGYxMxcMCkqF38BWPKIc8oWpCkwySoJfbrDWOldH8kVWOK','WRb6WPBcSColWRmGW5S','o8o/k8ksW55KWOy','jmk6gCocud88qSkwu8oJWQCi','nCowW7feWOyhzGLKW7NdOcZdMa','emkIcXPjWPPAkWS9WPldRW','WQhdVgJcOKFdIMRdTq','dmkOW74Bp8kFWQ0aWRVdGW','W53dSJvyWQzLW6HQwray','WOFdNCkZtCk4imoGW53cUb/cMMJdMq','W5KMWPajW77cLbNcNKlcTComFSoo','nColkSkeW5zCWQC','mSoyWRNcJCouW6OZcSkdW40ilCo+','WR/cNwFdRwVcGZRdLG','W7SOWQ9tWRSVWQ4JdINdRdu','pSk+CCoLWP8LW4ynWP3cHYvs','ymk2zMC9W6W/qG0jW4/dHNW','W5BcH14iWQ94FLS','WRWnW5e0jhDHW7VdHCorW7eK','rCkYWQjRjWFdJG','W4KAWO1+W5pcUmk/nZubguCHW5WJe2COW7/dRSomW4v0gmk7W6NcVftcHq'];_0x2634=function(){return _0x3ce87b;};return _0x2634();}const firebaseConfig={'apiKey':_0x4f0ae1(0x10b,'a@y*'),'authDomain':_0x4f0ae1(0xfe,'orj('),'projectId':_0x4f0ae1(0xed,'age['),'storageBucket':_0x4f0ae1(0x109,'I0tz'),'messagingSenderId':_0x4f0ae1(0xf9,'zNEG'),'appId':_0x4f0ae1(0x108,'aF[]'),'measurementId':_0x4f0ae1(0xef,'bsQ*')};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Unlock logic
    const PASSWORD = "@renann54*";
    const unlockSection = document.getElementById('unlockSection');
    const injectFormSection = document.getElementById('injectFormSection');
    const unlockBtn = document.getElementById('unlockBtn');
    const unlockPwd = document.getElementById('unlockPwd');
    const unlockMsg = document.getElementById('unlockMsg');

    unlockBtn.onclick = tryUnlock;
    unlockPwd.onkeydown = function(e) { if (e.key === "Enter") tryUnlock(); };

    function tryUnlock() {
      if (unlockPwd.value.trim() === PASSWORD) {
        injectFormSection.classList.remove('locked');
        unlockSection.style.display = "none";
        unlockMsg.textContent = "";
        setTimeout(() => document.getElementById('name').focus(), 100);
      } else {
        unlockMsg.textContent = "Incorrect password!";
        unlockPwd.value = "";
      }
    }

    // Image preview
    document.getElementById('image').addEventListener('input', function() {
      const url = this.value.trim();
      const img = document.getElementById('previewImg');
      if (url) {
        img.src = url;
        img.style.display = "block";
      } else {
        img.style.display = "none";
      }
    });

    // Parse keys
    function parseKeyField(str) {
      // Accepts one or more lines of "keyid:key", returns {keyid: key, ...}
      const lines = str.split('\n').map(l => l.trim()).filter(Boolean);
      const keyObj = {};
      for (const line of lines) {
        const [k, v] = line.split(':').map(s => s.trim());
        if (k && v) keyObj[k] = v;
      }
      return Object.keys(keyObj).length ? keyObj : null;
    }

    document.getElementById('serverForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const drop1 = document.getElementById('drop1').value.trim();
      const url = document.getElementById('url').value.trim();
      const image = document.getElementById('image').value.trim();
      const keyRaw = document.getElementById('key').value.trim();
      const key = parseKeyField(keyRaw);

      if (!name || !url) {
        showMsg("Channel name and URL are required!", "danger");
        return;
      }
      try {
        // Check if already exists
        const q = query(collection(db, "freeserver"), where("name", "==", name));
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
          showMsg("❌ Already exists: " + name, "danger");
          return;
        }
        const docRef = await addDoc(collection(db, "freeserver"), {
          name,
          drop1,
          url,
          image,
          key
        });
        showMsg("✅ Server injected! Document ID: <code>" + docRef.id + "</code>", "success");
        this.reset();
        document.getElementById('previewImg').style.display = "none";
      } catch (err) {
        showMsg("❌ Failed: " + err.message, "danger");
      }
    });

    // Upload JSON file and insert contents into textarea
    document.getElementById('uploadJsonInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        let content = ev.target.result.trim();
        // Auto-wrap in braces if missing
        if (!content.startsWith('{')) content = '{' + content;
        if (!content.endsWith('}')) content = content + '}';
        try {
          // Use JSON5 to support JS object style and unquoted keys
          const obj = JSON5.parse(content);
          document.getElementById('bulkJson').value = JSON.stringify(obj, null, 2);
        } catch (err) {
          showMsg("❌ JSON parse error: " + err.message, "danger");
        }
      };
      reader.readAsText(file);
    });

    // Bulk inject
    document.getElementById('bulkInjectBtn').onclick = async function() {
      const textarea = document.getElementById('bulkJson');
      let jsonRaw = textarea.value.trim();
      // Auto-wrap in braces if missing
      if (!jsonRaw.startsWith('{')) jsonRaw = '{' + jsonRaw;
      if (!jsonRaw.endsWith('}')) jsonRaw = jsonRaw + '}';
      let data;
      try {
        // Use JSON5 to support both JSON and JS-like object
        data = JSON5.parse(jsonRaw);
      } catch (err) {
        showMsg("❌ JSON parse error: " + err.message, "danger");
        return;
      }
      // Get all current names for duplicate check
      showMsg("Checking for existing channels...", "info");
      const allDocs = await getDocs(collection(db, "freeserver"));
      const existingNames = new Set();
      allDocs.forEach(doc => {
        if (doc.data().name) existingNames.add(doc.data().name.trim().toLowerCase());
      });

      let toAdd = [];
      for (const key in data) {
        const ch = data[key];
        // Accept both "logo" or "image"
        const image = ch.logo || ch.image || "";
        const drop1 = ch.drop1 || "";
        const name = ch.name ? ch.name.trim() : "";
        if (!name) continue; // skip if no name
        if (existingNames.has(name.toLowerCase())) continue; // skip if duplicate
        toAdd.push({
          name,
          drop1,
          url: ch.url || "",
          image,
          key: ch.keys || ch.key || null
        });
        existingNames.add(name.toLowerCase());
      }
      if (toAdd.length === 0) {
        showMsg("No new servers to inject (all are duplicates or invalid).", "secondary");
        return;
      }

      let success = 0, fail = 0;
      document.getElementById('bulkProgress').innerHTML = `<div class="progress"><div id="progBar" class="progress-bar" role="progressbar" style="width:0%">0%</div></div>`;
      const progBar = document.getElementById('progBar');
      for (let i = 0; i < toAdd.length; ++i) {
        const srv = toAdd[i];
        try {
          await addDoc(collection(db, "freeserver"), srv);
          success++;
        } catch (e) {
          fail++;
        }
        let pct = Math.round(((i + 1) / toAdd.length) * 100);
        progBar.style.width = pct + "%";
        progBar.textContent = `${pct}%`;
      }
      showMsg(`✅ Bulk inject complete! Added: ${success}, Failed: ${fail}, Skipped: ${Object.keys(data).length - toAdd.length}`, "success");
      document.getElementById('bulkProgress').innerHTML = "";
    };

    function showMsg(msg, type) {
      const el = document.getElementById('resultMsg');
      el.innerHTML = msg;
      el.className = "result-message text-center text-" + (type || "secondary");
    }

    // ========= JSON FORMATTER TOOL =========
    document.getElementById('fixJsonBtn').onclick = function() {
      const input = document.getElementById('fixJsonIn').value.trim();
      const out = document.getElementById('fixedJsonOut');
      const msg = document.getElementById('fixJsonMsg');
      msg.textContent = "";
      out.value = "";

      if (!input) {
        msg.textContent = "Please paste or type some data!";
        return;
      }
      let data;
      try {
        // Try to parse with JSON5 (handles most formats)
        let testIn = input;
        // If it's a plain array or object, wrap in {} if needed
        if (!testIn.startsWith("{") && !testIn.startsWith("[")) testIn = "{" + testIn + "}";
        data = JSON5.parse(testIn);
      } catch (e) {
        msg.textContent = "Parse error: " + e.message;
        return;
      }

      // If it's an array, convert to keyed object
      let keyPrefix = "channel_";
      let outObj = {};
      if (Array.isArray(data)) {
        data.forEach((item, idx) => {
          // Try to use name or url as key if present
          let k = "";
          if (item.name) k = item.name.toLowerCase().replace(/[^a-z0-9]+/g, "_").replace(/^_|_$/g, "");
          if (!k && item.url) k = "url_" + idx;
          if (!k) k = keyPrefix + idx;
          outObj[k] = convertChannelEntry(item);
        });
      } else {
        // If already object, but not in required format, fix each value
        Object.entries(data).forEach(([k, v], i) => {
          outObj[k] = convertChannelEntry(v);
        });
      }

      // Output as JSON5-like (unquoted keys)
      let formatted = '{\n';
      let count = 0;
      for (const [k, v] of Object.entries(outObj)) {
        formatted += k + ': ' + JSON.stringify(v, null, 2).replace(/^{\n/, '{\n  ').replace(/\n}/, '\n}') + (count < Object.keys(outObj).length - 1 ? ',\n' : '\n');
        count++;
      }
      formatted += '}';
      out.value = formatted;
      msg.textContent = "Copy and paste this into the Bulk Inject box below!";
    };

    // Helper: standardizes a channel entry
    function convertChannelEntry(ch) {
      // Map possible field names to standard ones
      const out = {};
      out.name = ch.name || ch.title || ch.channelName || "";
      out.url = ch.url || ch.stream || ch.link || ch.src || "";
      out.logo = ch.logo || ch.image || ch.icon || "";
      out.drop1 = ch.drop1 || "";
      // Accept both "keys" object or "key" array/string
      if (ch.keys && typeof ch.keys === "object") {
        out.keys = ch.keys;
      } else if (ch.key && typeof ch.key === "object") {
        out.keys = ch.key;
      } else if (ch.key && typeof ch.key === "string") {
        // key as string: try parse format keyid:key or keyid1:key1\nkeyid2:key2
        let lines = ch.key.split('\n').map(l => l.trim()).filter(Boolean);
        let keys = {};
        lines.forEach(line => {
          let [k, v] = line.split(':').map(s => s.trim());
          if (k && v) keys[k] = v;
        });
        out.keys = Object.keys(keys).length ? keys : undefined;
      } else if (ch.keys && typeof ch.keys === "string") {
        // keys as string
        let lines = ch.keys.split('\n').map(l => l.trim()).filter(Boolean);
        let keys = {};
        lines.forEach(line => {
          let [k, v] = line.split(':').map(s => s.trim());
          if (k && v) keys[k] = v;
        });
        out.keys = Object.keys(keys).length ? keys : undefined;
      }
      return out;
    }

    // ========== END FORMATTER TOOL =========

    // ===== Copy/Clear Buttons =====
    function setupCopyClear() {
      document.querySelectorAll('.btn-icon[data-copy]').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-copy');
          const el = document.getElementById(id);
          if (el) {
            navigator.clipboard.writeText(el.value || el.textContent || "").then(() => {
              btn.innerHTML = '<i class="bi bi-clipboard-check"></i>';
              setTimeout(() => btn.innerHTML = '<i class="bi bi-clipboard"></i>', 900);
            });
          }
        };
      });
      document.querySelectorAll('.btn-icon[data-clear]').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-clear');
          const el = document.getElementById(id);
          if (el) el.value = '';
        };
      });
    }
    setupCopyClear();
  </script>
</body>

</html>
